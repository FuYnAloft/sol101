# 1163B2. Cat Party (Hard Edition)

data structures, implementation, 1600, https://codeforces.com/contest/1163/problem/B2

*This problem is same as the previous one, but has larger constraints.*

Shiro's just moved to the new house. She wants to invite all friends of her to the house so they can play monopoly. However, her house is too small, so she can only invite one friend at a time.

For each of the ğ‘› days since the day Shiro moved to the new house, there will be exactly one cat coming to the Shiro's house. The cat coming in the ğ‘–-th day has a ribbon with color ğ‘¢ğ‘–. Shiro wants to know the largest number ğ‘¥, such that if we consider the streak of the first ğ‘¥ days, it is possible to remove **exactly one** day from this streak so that every ribbon color *that has appeared* among the remaining ğ‘¥âˆ’1âˆ’1 will have the same number of occurrences.

For example, consider the following sequence of ğ‘¢ğ‘–: \[2,2,1,1,5,4,4,5]. Then ğ‘¥=7 makes a streak, since if we remove the leftmost ğ‘¢ğ‘–=5, each ribbon color will appear exactly twice in the prefix of ğ‘¥âˆ’1 days. Note that ğ‘¥=8 doesn't form a streak, since you must remove exactly one day.

Since Shiro is just a cat, she is not very good at counting and needs your help finding the longest streak.

**Input**

The first line contains a single integer ğ‘› (1â‰¤ğ‘›â‰¤10^5^) â€” the total number of days.

The second line contains ğ‘› integers ğ‘¢1,ğ‘¢2,â€¦,ğ‘¢ğ‘› (1â‰¤ğ‘¢ğ‘–â‰¤10^5^) â€” the colors of the ribbons the cats wear.

**Output**

Print a single integer ğ‘¥ â€” the largest possible streak of days.

Examples

input

```
13
1 1 1 2 2 2 3 3 3 4 4 4 5
```

output

```
13
```

input

```
5
10 100 20 200 1
```

output

```
5
```

input

```
1
100000
```

output

```
1
```

input

```
7
3 2 1 1 4 5 1
```

output

```
6
```

input

```
6
1 1 1 2 2 2
```

output

```
5
```

Note

In the first example, we can choose the longest streak of 13 days, since upon removing the last day out of the streak, all of the remaining colors 1, 2, 3, and 4 will have the same number of occurrences of 33. Note that the streak can also be 10 days (by removing the 10-th day from this streak) but we are interested in the longest streak.

In the fourth example, if we take the streak of the first 66 days, we can remove the third day from this streak then all of the remaining colors 1, 2, 3, 4 and 5 will occur exactly once.



å½“å‰å¦‚æœæ»¡è¶³ï¼Œk+1æ˜¯ç­”æ¡ˆï¼›å¦‚æœå‰é¢çš„åˆ é™¤ä¸€ä¸ªå¯ä»¥æ»¡è¶³ï¼Œ(k-1)+1æ˜¯ç­”æ¡ˆã€‚å› ä¸ºkæ­¥é•¿æ˜¯1ï¼Œåªéœ€è¦è€ƒè™‘å‰é¢çš„åˆ é™¤ä¸€ä¸ªã€‚

```python
# 23 é‚“é”¦æ–‡
from collections import defaultdict
 
n = int(input())
colors = list(map(int, input().split()))
f = defaultdict(int)
mark_dict = defaultdict(int)
ans = 1
 
for k in range(1, n+1):
    color = colors[k-1]
    f[color] += 1
    mark_dict[f[color]] += 1
 
    if f[color]*mark_dict[f[color]] == k and k<n:
        #print(f'k1={k}')
        ans = k + 1
    elif f[color]*mark_dict[f[color]] == k-1:
        #print(f'k2={k}, {f[color]}, {mark_dict[f[color]]}')
        ans = k
 
print(ans)
```



We can iterate over all streaks and check for each streak if we can remove one day so that each color has the same number of cats.

There are 4 cases where we can remove a day from the streak to satisfy the condition:

- There is only one color in this streak.
- All appeared colors in this streak have the occurrence of 1 (i.e. every color has exactly 1 cat with that color).
- Every color has the same occurrence of cats, except for exactly one color which has the occurrence of 1.
- Every color has the same occurrence of cats, except for exactly one color which has the occurrence exactly 1 more than any other color.

All of these four conditions can be checked using counting techniques.

Complexity: ğ‘‚(ğ‘›).

```python
#ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ f æ¥è®°å½•æ¯ç§é¢œè‰²å‡ºç°çš„æ¬¡æ•°ï¼Œä½¿ç”¨å¦ä¸€ä¸ªæ•°ç»„ cnt æ¥ç»Ÿè®¡æ¯ä¸ªæ¬¡æ•°çš„é¢œè‰²æ•°é‡ã€‚
#é€šè¿‡è¿­ä»£é¢œè‰²åˆ—è¡¨ï¼Œå¹¶æ ¹æ®ä¸åŒçš„æ¡ä»¶åˆ¤æ–­ï¼Œè®¡ç®—å¹¶æ›´æ–°æœ€é•¿çš„è¿ç»­å¤©æ•° ansã€‚

n = int(input())
colors = list(map(int, input().split()))

N = 10**5 + 10
ans = 0
mx = 0
f = [0] * N
cnt = [0] * N

for i in range(1, n + 1):
    color = colors[i - 1]
    cnt[f[color]] -= 1
    f[color] += 1
    cnt[f[color]] += 1
    mx = max(mx, f[color])
    ok = False
    if cnt[1] == i:  # every color has occurrence of 1
        ok = True
    elif cnt[i] == 1:  # only one color has the maximum occurrence and the occurrence is i
        ok = True
    elif cnt[1] == 1 and cnt[mx] * mx == i - 1:  # one color has occurrence of 1 and other colors have the same occurrence
        ok = True
    elif cnt[mx - 1] * (mx - 1) == i - mx and cnt[mx] == 1:  # one color has the occurrence 1 more than any other color
        ok = True
    if ok:
        ans = i

print(ans)
```


