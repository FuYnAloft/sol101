# T28749: Top2æ‹›ç”Ÿå·¥ä½œ

http://cs101.openjudge.cn/practice/28749/

å°Pä½œä¸ºä¸€ä¸ªå­¦ä¹ è¿‡è®¡ç®—æ¦‚è®ºçš„è´µæ ¡å¤§ä¸€åŒå­¦ï¼Œå‚åŠ äº†æ‹›ç”Ÿå·¥ä½œï¼Œè´Ÿè´£æ•´ç†ä»Šå¹´è€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦ä»¬å¯¹äºTop2ä¸¤æ‰€å­¦æ ¡çš„å€¾å‘ï¼Œå…¶ä¸­å€¾å‘äºè´µæ ¡çš„åŒå­¦æ ‡è®°ä¸ºâ€œçº¢è‰²â€ï¼Œå€¾å‘äºéš”å£çš„åŒå­¦æ ‡è®°ä¸ºâ€œç´«è‰²â€ï¼Œæ²¡æœ‰å€¾å‘çš„åŒå­¦æ ‡è®°ä¸ºâ€œç™½è‰²â€ã€‚

å°Pè¿›å…¥æ‹›ç”Ÿç»„åäº†è§£åˆ°ï¼Œæ‹›ç”Ÿç»„ä¸­é è°±çš„å¿—æ„¿è€…å­¦é•¿å­¦å§å·²ç»åœ¨è€ƒå‰åšå¥½äº†æ‹›ç”Ÿçš„å‡†å¤‡å·¥ä½œï¼šæ¯ä¸€ä½å¿—æ„¿è€…å’Œä¸€ä½æˆ–è€…å¤šä½è€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦å»ºç«‹äº†è‰¯å¥½çš„è”ç³»ï¼Œä½†æ˜¯å› ä¸ºè´µæ ¡å¿—æ„¿è€…æ•°é‡æœ‰é™ï¼Œæ¯ä¸€ä½è€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦è‡³å¤šå’Œä¸¤ä½å¿—æ„¿è€…å»ºç«‹äº†è‰¯å¥½çš„è”ç³»ã€‚

å°Påœ¨æ¥å—æ‹›ç”Ÿç»„åŸ¹è®­æ—¶ï¼ŒçŸ¥é“äº†æ‹›ç”Ÿä¸­çš„é‡è¦ç‰¹ç‚¹ï¼š

- ã€Šè”ç³»ä¸ä¸Šã€‹ï¼šåœ¨å‡ºåˆ†åï¼Œè€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦åªä¼šå’Œå»ºç«‹äº†è‰¯å¥½è”ç³»çš„å¿—æ„¿è€…è¿›è¡Œæœ‰æ•ˆæ²Ÿé€š

- ã€Šæ‡’æƒ°çš„è´µæ ¡åŒå­¦ã€‹ï¼šä¸€æ¬¡æœ‰æ•ˆæ²Ÿé€šå¿…é¡»ç”±å¿—æ„¿è€…å‘èµ·ï¼Œå¹¶ä¸”å› ä¸ºè´µæ ¡å¿—æ„¿è€…æ¯”è¾ƒæ‡’ï¼Œæ‰€ä»¥ä¼šä¸€æ¬¡æ€§å’Œæ‰€æœ‰å…·æœ‰è‰¯å¥½è”ç³»çš„åŒå­¦æ²Ÿé€š

- ã€Šä¸°ä¿­ç”±äººã€‹ï¼šå¿—æ„¿è€…å¯ä»¥è¿›è¡Œè‹¥å¹²æ¬¡æœ‰æ•ˆæ²Ÿé€šï¼Œä¹Ÿå¯ä»¥å·æ‡’æ‘¸é±¼ä¸æ²Ÿé€š

- ã€Šç‹¬è‡ªè¾“å‡ºã€‹ï¼šéš”å£å› ä¸ºæŸäº›å› ç´ ï¼Œåœ¨ä»Šå¹´çš„æ‹›ç”Ÿä¸­é‡‡å–ä¸ä½œä¸ºç­–ç•¥ï¼Œå› æ­¤åŒå­¦å€¾å‘çš„æ”¹å˜ä»…å–å†³äºè´µæ ¡å¿—æ„¿è€…çš„æœ‰æ•ˆæ²Ÿé€š

- æ¯æ¬¡æœ‰æ•ˆæ²Ÿé€šçš„æ•ˆæœå¦‚ä¸‹ï¼š

  - ã€Šè¿‡çŠ¹ä¸åŠã€‹ï¼šåŸæœ¬å°±æ˜¯â€œçº¢è‰²â€å€¾å‘çš„åŒå­¦ä¼šå› ä¸ºåŒçƒ¦ï¼Œä¸€æ€’ä¹‹ä¸‹è½¬å˜ä¸ºâ€œç´«è‰²â€å€¾å‘
  - ã€Šæ‹‰æ‹¢ä¸­é—´æ´¾ã€‹ï¼šåŸæœ¬æ˜¯â€œç™½è‰²â€å€¾å‘çš„åŒå­¦ä¼šæ„Ÿå—åˆ°è´µæ ¡çš„çƒ­æƒ…ï¼Œè½¬å˜ä¸ºâ€œçº¢è‰²â€å€¾å‘
  - ã€Šæ‘‡æ‘†ä¸å®šã€‹ï¼šåŸæœ¬æ˜¯â€ç´«è‰²â€œå€¾å‘çš„åŒå­¦å—åˆ°è´µæ ¡çš„æ„Ÿå¬ï¼Œå†³å®šè½¬å˜ä¸ºâ€ç™½è‰²â€œå€¾å‘ï¼Œå¼€å§‹ä¸¤è¾¹æ‘‡æ‘†

   

æ‹›ç”Ÿç»„çŸ¥é“å°Pæ˜¯å­¦ä¹ è¿‡ç®—æ³•çš„å¤§ä½¬ï¼Œäºæ˜¯å°†å®‰æ’æ¯ä¸€ä½å¿—æ„¿è€…æœ‰æ•ˆæ²Ÿé€šæ¬¡æ•°çš„é‡ä»»äº¤ç»™äº†å°Pï¼Œå¸Œæœ›èƒ½å¤Ÿç”¨æœ€å°‘çš„æ€»æœ‰æ•ˆæ²Ÿé€šæ¬¡æ•°ï¼Œå®ç°å°†æ‰€æœ‰è€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦å€¾å‘å˜ä¸ºâ€œçº¢è‰²â€ã€‚

è¾“å…¥

è¾“å…¥çš„ç¬¬ä¸€è¡ŒåŒ…å«ä¸¤ä¸ªæ•´æ•°nå’Œmï¼Œå…¶ä¸­nï¼ˆ1 <= n <= 2*10^5ï¼‰æ˜¯è€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦çš„æ•°é‡ï¼ŒåŒå­¦ç¼–å·ä»1åˆ°nï¼›mï¼ˆ0 <= m <= 2nï¼‰æ˜¯å¿—æ„¿è€…çš„æ•°é‡ã€‚

è¾“å…¥çš„ç¬¬äºŒè¡ŒåŒ…å«æ˜¯ä¸€ä¸ªç”±nä¸ªå­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦æ˜¯R,P,Wä¸­çš„ä¸€ç§(Rä»£è¡¨å€¾å‘ä¸ºçº¢è‰²ï¼ŒPä»£è¡¨å€¾å‘ä¸ºç´«è‰²ï¼ŒWä»£è¡¨å€¾å‘ä¸ºç™½è‰²)ï¼Œå­—ç¬¦ä¸²ä¸­ç¬¬iä¸ªå­—ç¬¦ï¼Œå°±ä»£è¡¨äº†ç¬¬iä½åŒå­¦æœ€åˆçš„å€¾å‘ã€‚

æ¥ä¸‹æ¥çš„mè¡Œï¼Œæè¿°çš„æ˜¯ä¸æ¯ä¸€ä½å¿—æ„¿è€…å»ºç«‹äº†è‰¯å¥½è”ç³»çš„åŒå­¦çš„ä¿¡æ¯ï¼šæ¯ä¸€è¡Œä»¥ä¸€ä¸ªæ•´æ•°kï¼ˆ1 <= k <= nï¼‰å¼€å§‹ï¼Œä»£è¡¨äº†ä¸è¿™ä½å¿—æ„¿è€…å»ºç«‹è‰¯å¥½è”ç³»çš„åŒå­¦æ•°é‡ï¼Œä¹‹åè·Ÿç€kä¸ªä¸åŒçš„æ•´æ•°ï¼Œä»£è¡¨äº†è¿™äº›åŒå­¦çš„ç¼–å·ã€‚æ¯ä¸€ä½åŒå­¦è‡³å¤šå’Œä¸¤ä¸ªå¿—æ„¿è€…å»ºç«‹äº†è‰¯å¥½è”ç³»ã€‚

è¾“å‡º

å¦‚æœå¯ä»¥å®ç°å°†æ‰€æœ‰è€ƒå¾—æ¯”è¾ƒå¥½çš„åŒå­¦å€¾å‘å˜ä¸ºâ€œçº¢è‰²â€ï¼Œåˆ™è¾“å‡ºä¸€ä¸ªæ•´æ•°ï¼Œå³æ‰€éœ€è¦çš„æœ€å°‘æ€»æœ‰æ•ˆæ²Ÿé€šæ¬¡æ•°ï¼›å¦‚æœä¸èƒ½å¤Ÿå®ç°ï¼Œåˆ™è¾“å‡º"impossible"ã€‚

æ ·ä¾‹è¾“å…¥

```
sample1 input:
8 6
PWRWRRRP
2 1 4
1 2
4 4 5 6 7
3 5 6 7
1 8
1 8

sample1 output:
8
```

æ ·ä¾‹è¾“å‡º

```
sample2 input:
4 3
RPWR
2 1 2
2 2 3
2 3 4

sample2 output:
impossible
```

æç¤º

Recursion, æ´ªæ°´å¡«å…… , 1100

Pythonç¨‹åºå¸¸ç”¨çš„ä¼˜åŒ–æœ‰ä¸‰ä¸ªï¼šsys.setrecursionlimit(1<<30)ã€@lru_cache(maxsize = None)ã€sys.stdin.readã€‚å‰ä¸¤ä¸ªä¸»è¦æ˜¯è§£å†³é€’å½’ç¨‹åºçˆ†æ ˆå’Œé‡å¤è®¡ç®—å­é—®é¢˜ï¼Œåä¸€ä¸ªè§£å†³è¾“å…¥æ•°æ®å¤ªå¤šçš„é—®é¢˜ã€‚åŒå­¦å¯ä»¥ä½¿ç”¨å…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ¥ä¼˜åŒ–ç¨‹åºã€‚

æ¥æº

2024 TA-Xjk





**ä¸€ã€é¢˜æ„æ¦‚æ‹¬**

æ¯ä¸ªå­¦ç”Ÿå±äºä¸‰ç§ç±»å‹ä¹‹ä¸€ï¼š

- `R`ï¼ˆçº¢ï¼‰ â†’ 0
- `P`ï¼ˆè“ï¼‰ â†’ 1
- `W`ï¼ˆç™½ï¼‰ â†’ 2

æ¯ä¸ªå­¦ç”Ÿæœ€å¤šå¯ä»¥æŠ¥åä¸¤ä¸ªå¿—æ„¿ï¼ˆå³ä¸¤ä¸ªâ€œå¿—æ„¿è€…/æ‹›ç”Ÿç‚¹â€ï¼‰ã€‚
æ¯ä¸ªå¿—æ„¿è€…ä¹Ÿå¯ä»¥è¢«å¤šä¸ªå­¦ç”ŸæŠ¥è€ƒã€‚

é¢˜ç›®ç»™å‡ºçš„çº¦æŸæ˜¯ï¼š
å¯¹æ¯ä¸ªå­¦ç”Ÿ `i`ï¼š

- è‹¥ä»–æŠ¥äº†ä¸¤ä¸ªå¿—æ„¿è€… `v1, v2`ï¼Œåˆ™æœ‰ä¸€ä¸ªçº¦æŸæ–¹ç¨‹ï¼š
  $(x_{v1} + x_{v2} + a_i) \equiv 0 \pmod{3}$
- è‹¥ä»–åªæŠ¥äº†ä¸€ä¸ªå¿—æ„¿è€… `v`ï¼Œåˆ™ï¼š
  $(x_v + a_i) \equiv 0 \pmod{3}$
- è‹¥ä»–ä¸€ä¸ªå¿—æ„¿éƒ½æ²¡æŠ¥ï¼Œåˆ™å¿…é¡»æ˜¯ `R` ç±»å‹ï¼ˆå³ `a_i = 0`ï¼‰ã€‚

ç›®æ ‡ï¼šæ‰¾åˆ°æ‰€æœ‰å¿—æ„¿è€…çš„å–å€¼ï¼ˆ0,1,2ï¼‰ï¼Œä½¿æ‰€æœ‰æ–¹ç¨‹æˆç«‹ï¼Œå¹¶ä½¿å¿—æ„¿è€…çš„å€¼ä¹‹å’Œæœ€å°ï¼ˆå³æ€»ä»£ä»·æœ€å°ï¼‰ã€‚

------

**äºŒã€è½¬åŒ–ä¸ºå›¾é—®é¢˜**

- å¿—æ„¿è€…æ˜¯**èŠ‚ç‚¹**ï¼›
- å­¦ç”Ÿæä¾›äº†**çº¦æŸæ–¹ç¨‹**ï¼›
- æ¯ä¸ªå­¦ç”Ÿå¯¹åº”ä¸€æ¡æˆ–å¤šæ¡**è¾¹**ï¼š

| å­¦ç”Ÿç±»å‹ | å¿—æ„¿ä¸ªæ•° | å¯¹å¿—æ„¿è€…çº¦æŸ                              |
| -------- | -------- | ----------------------------------------- |
| 0 ä¸ªå¿—æ„¿ | â€”        | è‹¥éRï¼Œåˆ™ä¸å¯èƒ½                           |
| 1 ä¸ªå¿—æ„¿ | 1        | `x_v = (-a_i) mod 3` â†’ å¿—æ„¿è€…å–å®šå€¼       |
| 2 ä¸ªå¿—æ„¿ | 2        | `x_u + x_v = (-a_i) mod 3` â†’ å¿—æ„¿è€…é—´å…³ç³» |

äºæ˜¯æˆ‘ä»¬æ„å»ºå¿—æ„¿è€…å›¾ï¼š

- è¾¹ `(u,v,b)` è¡¨ç¤ºï¼š`x_u + x_v â‰¡ b (mod3)`ï¼›
- èŠ‚ç‚¹å¯èƒ½æœ‰å›ºå®šå€¼ï¼ˆæ¥è‡ªå•å¿—æ„¿å­¦ç”Ÿï¼‰ã€‚

------

**ä¸‰ã€ç®—æ³•æ­¥éª¤**

1. **è¯»å…¥å­¦ç”Ÿä¸å¿—æ„¿è€…ä¿¡æ¯**ï¼Œè½¬æ¢æˆæ•°å­—ï¼ˆR=0, P=1, W=2ï¼‰ã€‚
2. **æ£€æµ‹æ— å¿—æ„¿å­¦ç”Ÿ**ï¼šè‹¥ä¸æ˜¯Rï¼Œåˆ™ç›´æ¥ `impossible`ã€‚
3. **å»ºç«‹å¿—æ„¿è€…å›¾ï¼š**
   - å¯¹åŒå¿—æ„¿å­¦ç”Ÿï¼ŒåŠ è¾¹ï¼›
   - å¯¹å•å¿—æ„¿å­¦ç”Ÿï¼Œè®°å½•èŠ‚ç‚¹çš„å›ºå®šå€¼ã€‚
4. **æ£€æµ‹çŸ›ç›¾å›ºå®šå€¼**ï¼ˆåŒä¸€å¿—æ„¿è€…è¢«è¦æ±‚å¤šä¸ªä¸åŒå›ºå®šå€¼ï¼‰ã€‚
5. **åœ¨å¿—æ„¿è€…å›¾ä¸Šè¿›è¡Œ BFS/DFS è¿é€šåˆ†é‡éå†ï¼š**
   - è‹¥åˆ†é‡å†…æœ‰å›ºå®šç‚¹ â†’ ä»¥è¿™äº›ä¸ºæ ¹è¿›è¡Œå€¼ä¼ æ’­ï¼›
   - è‹¥æ²¡æœ‰å›ºå®šç‚¹ â†’ ä»»é€‰ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ ¹ï¼Œå°è¯• 3 ç§èµ·å§‹å€¼ï¼ˆ0/1/2ï¼‰ï¼Œé€‰å‡ºåˆæ³•ä¸”æ€»ä»£ä»·æœ€å°çš„æ–¹æ¡ˆï¼›
   - è‹¥å‡ºç°å†²çªï¼ˆæ–¹ç¨‹ä¸æˆç«‹ï¼‰â†’ `impossible`ã€‚
6. **ç´¯åŠ æ¯ä¸ªåˆ†é‡çš„æœ€å°ä»£ä»·**ã€‚
7. **è¾“å‡ºæ€»ä»£ä»·**ã€‚

------

**å››ã€å¤æ‚åº¦åˆ†æ**

- å»ºå›¾ï¼šO(n + m)
- BFS/DFSï¼šO(m + n)
- æ¯ä¸ªåˆ†é‡æœ€å¤šå°è¯• 3 æ¬¡ä¼ æ’­
  æ€»ä½“å¤æ‚åº¦ O((n + m) * 3) â‰ˆ O(n + m)ï¼Œå¯è½»æ¾é€šè¿‡ã€‚

------

âœ… å¸¦ä¸­æ–‡æ³¨é‡Šçš„å®Œæ•´ä»£ç 

```python
import sys
from collections import deque, defaultdict
sys.setrecursionlimit(1 << 25)
input = sys.stdin.readline

# === è¾“å…¥é˜¶æ®µ ===
n, m = map(int, input().split())
s = input().strip()

# R=0, P=1, W=2
enc = {'R':0, 'P':1, 'W':2}
a = [enc[ch] for ch in s]

# æ¯ä¸ªå­¦ç”Ÿçš„å¿—æ„¿åˆ—è¡¨ï¼ˆ0-indexï¼‰
stu = [[] for _ in range(n)]
# æ¯ä¸ªå¿—æ„¿è€…å¯¹åº”çš„å­¦ç”Ÿ
vol = [[] for _ in range(m)]

for vid in range(m):
    parts = list(map(int, input().split()))
    k = parts[0]
    for x in parts[1:]:
        x0 = x-1
        stu[x0].append(vid)
        vol[vid].append(x0)

# === åŸºæœ¬åˆæ³•æ€§æ£€æµ‹ ===
for i in range(n):
    if not stu[i] and a[i] != 0:
        print("impossible")
        sys.exit(0)

# === å»ºç«‹å¿—æ„¿è€…å›¾ ===
# å¯¹äºåŒå¿—æ„¿å­¦ç”Ÿï¼Œå¢åŠ ä¸€æ¡è¾¹ (v1,v2,b)
# å¯¹äºå•å¿—æ„¿å­¦ç”Ÿï¼Œè®°å½•è¯¥å¿—æ„¿è€…å›ºå®šå€¼ b
adj = [[] for _ in range(m)]
fixed_constraints = defaultdict(list)  # vid -> æœŸæœ›å€¼åˆ—è¡¨

for i in range(n):
    vs = stu[i]
    if len(vs) == 2:
        v1, v2 = vs
        b = (-a[i]) % 3
        adj[v1].append((v2, b))
        adj[v2].append((v1, b))
    elif len(vs) == 1:
        v = vs[0]
        b = (-a[i]) % 3
        fixed_constraints[v].append(b)

# === æ£€æŸ¥å›ºå®šå€¼å†²çª ===
for v, lst in fixed_constraints.items():
    first = lst[0]
    for val in lst:
        if val % 3 != first % 3:
            print("impossible")
            sys.exit(0)

fixed_value = {v: lst[0] % 3 for v, lst in fixed_constraints.items()}

# === BFS éå†å¿—æ„¿è€…å›¾ ===
visited = [False]*m
total_cost = 0

# è¾…åŠ©å‡½æ•°ï¼šç»™å®šåˆå§‹æ ¹èŠ‚ç‚¹èµ‹å€¼ï¼Œä¼ æ’­çº¦æŸ
def try_with_roots(root_assignments):
    assigned = {}
    dq = deque()
    for k, vv in root_assignments.items():
        assigned[k] = vv % 3
        dq.append(k)
    while dq:
        u = dq.popleft()
        xu = assigned[u]
        for (w, b) in adj[u]:
            exp = (b - xu) % 3
            if w in assigned:
                if assigned[w] != exp:
                    return None  # å†²çª
            else:
                assigned[w] = exp
                dq.append(w)
    return assigned

# === å¤„ç†æ‰€æœ‰è¿é€šåˆ†é‡ ===
for v_start in range(m):
    if visited[v_start] or not vol[v_start]:
        visited[v_start] = True
        continue

    # æ”¶é›†è¯¥è¿é€šåˆ†é‡æ‰€æœ‰èŠ‚ç‚¹
    comp_nodes = []
    q = deque([v_start])
    visited[v_start] = True
    while q:
        u = q.popleft()
        comp_nodes.append(u)
        for (w, _) in adj[u]:
            if not visited[w]:
                visited[w] = True
                q.append(w)

    # è‹¥è¯¥åˆ†é‡å†…æœ‰å›ºå®šå€¼ï¼Œç›´æ¥ä¼ æ’­
    comp_fixed = {u: fixed_value[u] for u in comp_nodes if u in fixed_value}
    if comp_fixed:
        res = try_with_roots(comp_fixed)
        if res is None:
            print("impossible")
            sys.exit(0)
        # æœªè¢«çº¦æŸçš„èŠ‚ç‚¹å¯è®¾ä¸º0ä»¥æœ€å°åŒ–ä»£ä»·
        for u in comp_nodes:
            if u not in res:
                res[u] = 0
        total_cost += sum(res[u] for u in comp_nodes)
        continue

    # å¦åˆ™ï¼Œå°è¯• root=0,1,2 ä¸‰ç§æƒ…å†µ
    root = comp_nodes[0]
    best = None
    for r in range(3):
        res = try_with_roots({root: r})
        if res is None:
            continue
        for u in comp_nodes:
            if u not in res:
                res[u] = 0
        cost = sum(res[u] for u in comp_nodes)
        if best is None or cost < best:
            best = cost

    if best is None:
        print("impossible")
        sys.exit(0)
    total_cost += best

# === è¾“å‡ºç»“æœ ===
print(total_cost)
```

------

ğŸ’¡ æ ¸å¿ƒæ€è·¯æ€»ç»“

- æœ¬é¢˜å®è´¨æ˜¯ä¸€ä¸ª **æ¨¡ 3 çº¿æ€§æ–¹ç¨‹ç³»ç»Ÿ**ï¼›
- å¿—æ„¿è€…ä¸ºå˜é‡ï¼Œå­¦ç”Ÿä¸ºçº¦æŸï¼›
- æ¯ä¸ªè¿é€šåˆ†é‡ç‹¬ç«‹æ±‚è§£ï¼›
- æœ‰å›ºå®šç‚¹çš„åˆ†é‡ç›´æ¥ç¡®å®šï¼›
- æ— å›ºå®šç‚¹çš„åˆ†é‡éœ€å°è¯•ä¸‰ç§èµ·ç‚¹ï¼›
- å–æœ€å°ä»£ä»·ï¼ˆå³å¿—æ„¿è€…å–å€¼ä¹‹å’Œæœ€å°ï¼‰ã€‚







ğŸ’¡ é¢˜ç›®ç†è§£ä¸å»ºæ¨¡

é¢˜ç›®çœ‹ä¼¼æè¿°æ‹›ç”Ÿæ•…äº‹ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ª**æ¨¡ 3 çš„çº¿æ€§æ–¹ç¨‹ç³»ç»Ÿ + è¿é€šåˆ†é‡æœ€å°åŒ–é—®é¢˜**ã€‚

------

**ä¸€ã€çŠ¶æ€å˜åŒ–è§„å¾‹ï¼ˆæ ¸å¿ƒï¼‰**

æ¯ä¸ªå­¦ç”Ÿæœ‰ä¸‰ç§çŠ¶æ€ï¼š

- Rï¼ˆçº¢ï¼‰= 0
- Pï¼ˆç´«ï¼‰= 1
- Wï¼ˆç™½ï¼‰= 2

ä¸€æ¬¡â€œæ²Ÿé€šâ€æ“ä½œä¼šè®©å¿—æ„¿è€…è”ç³»åˆ°çš„æ‰€æœ‰å­¦ç”Ÿçš„çŠ¶æ€å‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š

| åˆå§‹ | æ²Ÿé€šå |
| ---- | ------ |
| R(0) | P(1)   |
| P(1) | W(2)   |
| W(2) | R(0)   |

å³ï¼š**çŠ¶æ€å€¼ +1ï¼ˆmod 3ï¼‰**

------

**äºŒã€å¿—æ„¿è€…å˜é‡å®šä¹‰**

ä»¤ç¬¬ $i$ ä¸ªå¿—æ„¿è€…è¿›è¡Œ $x_i$ æ¬¡æ²Ÿé€šï¼ˆå–æ¨¡ 3ï¼‰ã€‚

å¯¹æŸä¸ªå­¦ç”Ÿ $s$ï¼Œè‹¥ä¸å¿—æ„¿è€…é›†åˆ $V_s = {v_1, v_2}$ å»ºç«‹è”ç³»ï¼Œåˆ™è¯¥å­¦ç”Ÿçš„æœ€ç»ˆçŠ¶æ€ä¸ºï¼š

$a_s + x_{v_1} + x_{v_2} \equiv 0 \pmod{3}$

ï¼ˆè¦æ±‚æœ€ç»ˆä¸ºçº¢è‰²ï¼Œå³çŠ¶æ€å€¼ä¸º 0ï¼‰

å› æ­¤ï¼š

$x_{v_1} + x_{v_2} \equiv -a_s \pmod{3}$

------

**ä¸‰ã€æ ¹æ®å­¦ç”Ÿçš„å¿—æ„¿è€…æ•°æ„é€ çº¦æŸ**

âœ… æƒ…å†µ 1ï¼šå­¦ç”Ÿæœ‰ä¸¤ä¸ªå¿—æ„¿è€…

å¾—åˆ°ä¸€æ¡ **å¿—æ„¿è€…ä¹‹é—´çš„è¾¹**ï¼š

$x_u + x_v = b \pmod{3}$
å…¶ä¸­ $b = (-a_s) \bmod 3$ã€‚

å³ï¼š**åœ¨å¿—æ„¿è€…å›¾ä¸­æ·»åŠ ä¸€æ¡å¸¦æƒè¾¹ (u,v,b)**ã€‚

âœ… æƒ…å†µ 2ï¼šå­¦ç”Ÿåªæœ‰ä¸€ä¸ªå¿—æ„¿è€…

å¾—åˆ°ä¸€æ¡ **å›ºå®šçº¦æŸ**ï¼š

$x_v = b \pmod{3}$

å³ï¼š**è¯¥å¿—æ„¿è€…çš„å€¼è¢«å›ºå®š**ã€‚

âŒ æƒ…å†µ 3ï¼šå­¦ç”Ÿæ²¡æœ‰å¿—æ„¿è€…

è‹¥ä»–ä¸æ˜¯çº¢è‰²ï¼Œåˆ™æ°¸è¿œæ— æ³•å˜çº¢ï¼Œç›´æ¥è¾“å‡º `impossible`ã€‚

------

**å››ã€é—®é¢˜è½¬åŒ–ä¸ºå›¾é—®é¢˜**

æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª **å¸¦æ¨¡çº¦æŸçš„å›¾**ï¼š

- èŠ‚ç‚¹ï¼šå¿—æ„¿è€…
- è¾¹ï¼šæ¥è‡ªä¸¤ä¸ªå¿—æ„¿è€…å…±è”ä¸€ä¸ªå­¦ç”Ÿçš„çº¦æŸ
- èŠ‚ç‚¹å›ºå®šå€¼ï¼šæ¥è‡ªå•å¿—æ„¿è€…å­¦ç”Ÿ
- æ¯ä¸ªè¿é€šåˆ†é‡å¯ä»¥ç‹¬ç«‹æ±‚è§£

ä»»åŠ¡ï¼š

1. åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†²çªï¼ˆmod 3 çŸ›ç›¾ï¼‰
2. è‹¥å­˜åœ¨å¤šç§å¯è¡Œèµ‹å€¼ï¼Œé€‰å–æ²Ÿé€šæ¬¡æ•°ä¹‹å’Œæœ€å°çš„æ–¹æ¡ˆï¼ˆæ¯ä¸ªå¿—æ„¿è€…çš„æ²Ÿé€šæ¬¡æ•°æ˜¯ 0/1/2ï¼‰

------

äº”ã€è¿é€šåˆ†é‡æ±‚è§£é€»è¾‘

1. è‹¥è¯¥åˆ†é‡ä¸­å­˜åœ¨å›ºå®šå¿—æ„¿è€…å€¼ï¼Œåˆ™ä»å®ƒå‡ºå‘ BFS æ¨å¯¼æ‰€æœ‰èŠ‚ç‚¹çš„å€¼ã€‚è‹¥å‡ºç°çŸ›ç›¾ â†’ impossibleã€‚
2. è‹¥è¯¥åˆ†é‡æ²¡æœ‰å›ºå®šå¿—æ„¿è€…ï¼š
   - ä»»æ„é€‰ä¸€ä¸ªå¿—æ„¿è€…ä¸ºæ ¹ï¼Œå°è¯•ä»¤å…¶å–å€¼ 0ã€1ã€2ï¼›
   - æ¯ç§æƒ…å†µ BFS æ¨å¯¼ï¼›
   - è‹¥å†²çªåˆ™ä¸¢å¼ƒï¼›
   - åœ¨æ‰€æœ‰å¯è¡Œæ–¹æ¡ˆä¸­é€‰æ€»æ²Ÿé€šæ¬¡æ•°æœ€å°çš„æ–¹æ¡ˆã€‚

æœ€ç»ˆæŠŠæ¯ä¸ªåˆ†é‡çš„æœ€ä¼˜è§£ç›¸åŠ ã€‚

------

âœ… AC ä»£ç ï¼ˆå¸¦è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼‰

```python
import sys
from collections import deque

def main():
    # ---------- å¿«é€Ÿè¯»å…¥ ----------
    data = sys.stdin.buffer.read().split()
    it = iter(data)
    n = int(next(it)); m = int(next(it))
    s = next(it).decode()

    # ---------- ç¼–ç å€¾å‘ ----------
    enc = {'R':0, 'P':1, 'W':2}
    a = [enc[ch] for ch in s]

    # ---------- å»ºç«‹å­¦ç”Ÿå’Œå¿—æ„¿è€…å…³ç³» ----------
    stu = [[] for _ in range(n)]   # æ¯ä¸ªå­¦ç”Ÿå¯¹åº”çš„å¿—æ„¿è€…
    vol = [[] for _ in range(m)]   # æ¯ä¸ªå¿—æ„¿è€…å¯¹åº”çš„å­¦ç”Ÿ
    for vid in range(m):
        k = int(next(it))
        for _ in range(k):
            x = int(next(it)) - 1
            stu[x].append(vid)
            vol[vid].append(x)

    # ---------- æ£€æŸ¥æ— å¿—æ„¿è€…çš„å­¦ç”Ÿ ----------
    for i in range(n):
        if not stu[i] and a[i] != 0:
            print("impossible")
            return

    # ---------- æ„é€ å¿—æ„¿è€…ä¹‹é—´çš„çº¦æŸå›¾ ----------
    adj = [[] for _ in range(m)]     # é‚»æ¥è¡¨ï¼Œå­˜å‚¨ (é‚»å±…, b)
    fixed_value = [-1] * m           # æŸå¿—æ„¿è€…çš„å›ºå®šå€¼ï¼ˆè‹¥æœ‰å•å¿—æ„¿è€…å­¦ç”Ÿçº¦æŸï¼‰

    for i in range(n):
        vs = stu[i]
        if len(vs) == 2:
            v1, v2 = vs
            b = (-a[i]) % 3
            adj[v1].append((v2, b))
            adj[v2].append((v1, b))
        elif len(vs) == 1:
            v = vs[0]
            b = (-a[i]) % 3
            if fixed_value[v] == -1:
                fixed_value[v] = b
            elif fixed_value[v] != b:
                print("impossible")
                return
        # len==0 æƒ…å†µå‰é¢å·²æ’é™¤

    # ---------- åˆå§‹åŒ– ----------
    visited = [False] * m
    assigned = [-2] * m  # å¿—æ„¿è€…æ²Ÿé€šæ¬¡æ•°ï¼š-2=æœªèµ‹å€¼ï¼Œ0/1/2=æ¬¡æ•° mod3
    total_cost = 0

    # ---------- é€ä¸ªè¿é€šåˆ†é‡å¤„ç† ----------
    for v in range(m):
        if visited[v]:
            continue
        if not vol[v]:  # æ²¡å…³è”å­¦ç”Ÿçš„å¿—æ„¿è€…ï¼Œè·³è¿‡
            visited[v] = True
            continue

        # BFS æ”¶é›†è¯¥è¿é€šåˆ†é‡å†…æ‰€æœ‰å¿—æ„¿è€…
        comp = []
        dq = deque([v])
        visited[v] = True
        while dq:
            u = dq.popleft()
            comp.append(u)
            for w, _ in adj[u]:
                if not visited[w]:
                    visited[w] = True
                    dq.append(w)

        # æ‰¾å‡ºè¯¥åˆ†é‡å†…çš„å›ºå®šèŠ‚ç‚¹
        comp_fixed_nodes = [u for u in comp if fixed_value[u] != -1]

        # ---------- BFSä¼ æ’­å‡½æ•° ----------
        def propagate_init(init_list):
            touched = []  # è®°å½•è¢«ä¿®æ”¹è¿‡çš„å¿—æ„¿è€…ï¼Œæ–¹ä¾¿å›æ»š
            q = deque()
            for (uu, val) in init_list:
                assigned[uu] = val
                touched.append(uu)
                q.append(uu)
            # ä¼ æ’­çº¦æŸï¼šx_v = (b - x_u) mod 3
            while q:
                uu = q.popleft()
                xuu = assigned[uu]
                for vv, b in adj[uu]:
                    need = (b - xuu) % 3
                    cur = assigned[vv]
                    if cur == -2:
                        assigned[vv] = need
                        touched.append(vv)
                        q.append(vv)
                    elif cur != need:
                        # å†²çª -> å›æ»šå¹¶è¿”å›å¤±è´¥
                        for t in touched:
                            assigned[t] = -2
                        return None
            return touched  # è¿”å›æˆåŠŸä¿®æ”¹çš„èŠ‚ç‚¹åˆ—è¡¨

        # ---------- æƒ…å†µ 1ï¼šè¯¥åˆ†é‡æœ‰å›ºå®šå¿—æ„¿è€… ----------
        if comp_fixed_nodes:
            init_list = [(u, fixed_value[u]) for u in comp_fixed_nodes]
            touched = propagate_init(init_list)
            if touched is None:
                print("impossible")
                return
            # æœªè¿æ¥çš„èŠ‚ç‚¹è®¾ä¸º0
            comp_cost = 0
            for u in comp:
                if assigned[u] == -2:
                    assigned[u] = 0
                comp_cost += assigned[u]
            total_cost += comp_cost
            continue

        # ---------- æƒ…å†µ 2ï¼šè¯¥åˆ†é‡æ— å›ºå®šå¿—æ„¿è€… ----------
        root = comp[0]
        best_cost = None
        best_touched = None

        # å°è¯•æ ¹èŠ‚ç‚¹ä¸º 0,1,2 çš„ä¸‰ç§æƒ…å†µ
        for r in (0,1,2):
            touched = propagate_init([(root, r)])
            if touched is None:
                continue
            # æœªèµ‹å€¼çš„èŠ‚ç‚¹è®¾ä¸º0
            for u in comp:
                if assigned[u] == -2:
                    assigned[u] = 0
                    touched.append(u)
            cost = sum(assigned[u] for u in comp)
            if best_cost is None or cost < best_cost:
                best_cost = cost
                best_touched = list(touched)
            # å›æ»šï¼Œä¸ºä¸‹æ¬¡å°è¯•æ¸…ç©ºçŠ¶æ€
            for t in touched:
                assigned[t] = -2

        if best_cost is None:
            print("impossible")
            return

        # é‡æ–°ä¼ æ’­æœ€ä¼˜æ–¹æ¡ˆå¹¶ä¿ç•™ç»“æœ
        propagate_init([(root, 0)])
        for u in comp:
            if assigned[u] == -2:
                assigned[u] = 0
        total_cost += best_cost

    # ---------- è¾“å‡ºæœ€å°æ€»æ²Ÿé€šæ¬¡æ•° ----------
    print(total_cost)

if __name__ == "__main__":
    main()
```

------

ğŸ§  æ€è·¯æ€»ç»“ï¼ˆç®€æ´ç‰ˆï¼‰

| æ­¥éª¤ | å«ä¹‰                                  | æ“ä½œ                                |
| ---- | ------------------------------------- | ----------------------------------- |
| 1    | æŠŠæ¯ä¸ªå­¦ç”Ÿçš„çŠ¶æ€è½¬ä¸ºæ•°å­— 0/1/2        | Râ†’0, Pâ†’1, Wâ†’2                       |
| 2    | æ ¹æ®å­¦ç”Ÿè¿æ¥çš„å¿—æ„¿è€…æ•°ï¼Œæ„é€ æ¨¡ 3 æ–¹ç¨‹ | ä¸¤å¿—æ„¿è€…â†’ç­‰å¼ï¼›ä¸€å¿—æ„¿è€…â†’å›ºå®šå€¼      |
| 3    | æ„é€ å¿—æ„¿è€…å›¾                          | æ¯ä¸ªå¿—æ„¿è€…æ˜¯èŠ‚ç‚¹ï¼Œè¾¹æƒè¡¨ç¤ºæ¨¡ 3 å…³ç³» |
| 4    | åˆ†åˆ«å¤„ç†æ¯ä¸ªè¿é€šåˆ†é‡                  | BFS ä¼ æ’­è§£æ¨¡ 3 çº¿æ€§ç³»ç»Ÿ             |
| 5    | è‹¥æœ‰å¤šè§£ï¼Œæšä¸¾æ ¹å–æœ€å°ä»£ä»·            | root=0/1/2 ä¸‰ç§æ–¹æ¡ˆ                 |
| 6    | æ±‡æ€»æœ€å°æ²Ÿé€šæ¬¡æ•°                      | è¾“å‡ºç»“æœ                            |

------

âœ… å¤æ‚åº¦åˆ†æ

| éƒ¨åˆ†              | å¤æ‚åº¦                    |
| ----------------- | ------------------------- |
| æ„å»ºå›¾            | O(n + m)                  |
| BFSä¼ æ’­           | O(n + m)                  |
| æ¯åˆ†é‡æšä¸¾3ç§root | æœ€å¤š 3Ã—O(èŠ‚ç‚¹æ•°)          |
| **æ€»å¤æ‚åº¦**      | **O(n + m)** ï¼ˆå¸¸æ•°æå°ï¼‰ |

å†…å­˜å ç”¨ä¹Ÿä¸º O(n + m)ï¼Œå®Œå…¨å¯é€šè¿‡ 2Ã—10âµ çº§åˆ«æ•°æ®ã€‚

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜å¯ä»¥å¸®ä½ ç”»ä¸€å¼  **â€œå¿—æ„¿è€…-å­¦ç”Ÿå›¾ + çŠ¶æ€å˜åŒ– mod3 åŠ¨æ€ç¤ºæ„å›¾â€**ï¼ˆæ¯”å¦‚æ ·ä¾‹è¾“å…¥ï¼‰ï¼Œå¸®åŠ©ç›´è§‚ç†è§£ â€œx_u + x_v â‰¡ b (mod 3)â€ æ˜¯å¦‚ä½•ä¼ æ’­çš„ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ


